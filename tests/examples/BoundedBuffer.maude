load creol-interpreter .
mod PROGRAM is
  protecting CREOL-SIMULATOR .
  op classes : -> Configuration [ctor] .
  eq classes =
    < "BoundedBuffer" : Class | Inh: noInh, Param: noVid, Att: "buffer" |->
      null, "max" |-> null, "n" |-> null,
      Mtds: < "init" : Method | Param: noVid, Att: "_" |-> null,
              Code: assign( ( "buffer" @ "BoundedBuffer" ),
              ( "max" @ "BoundedBuffer" ),
              ( "n" @ "BoundedBuffer" ) ; list(emp) :: int(10) :: int(0) ) ;
              skip ; return ( emp ) >,
            < "run" : Method | Param: noVid, Att: "_" |-> null, Code: skip ;
              return ( emp ) >,
            < "append" : Method | Param: "d", Att: "d" |-> null, "_" |->
              null, Code: await "<" ( "n" :: "max" ) ; assign( "buffer",
              "n" ; "|-" ( "buffer" :: "d" ) :: "+" ( "n" :: int(1) ) ) ;
              return ( emp ) >,
            < "remove" : Method | Param: noVid, Att: "d" |-> null, "_" |->
              null, Code: await ">" ( "n" :: int(0) ) ;
              assign( "d" ; "head" ( "buffer" ) ) ; assign( "buffer",
              "n" ; "tail" ( "buffer" ) :: "-" ( "n" :: int(1) ) ) ;
              return ( "d" ) >,
      Ocnt: 0 >
    
    < "Producer" : Class | Inh: noInh, Param: "b", Att: "b" |-> null,
      Mtds: < "init" : Method | Param: noVid, Att: "_" |-> null, Code: skip ;
              return ( emp ) >,
            < "run" : Method | Param: noVid, Att: "label:0" |-> null, "_" |->
              null, Code: call( "label:0" ; "this" ; "loop" ; int(0) ) ;
              free( "label:0" ) ; return ( emp ) >,
            < "loop" : Method | Param: "i", Att: "i" |-> null, "label:1" |->
              null, "label:0" |-> null, "_" |-> null, Code: call( "label:0" ;
              "b" ; "append" ; "i" ) ; get( "label:0" ; noVid ) ;
              free( "label:0" ) ;
              call( "label:1" ; "this" ; "loop" ; "+" ( "i" :: int(1) ) ) ;
              free( "label:1" ) ; return ( emp ) >,
      Ocnt: 0 >
    
    < "Consumer" : Class | Inh: noInh, Param: "b", Att: "b" |-> null,
      Mtds: < "init" : Method | Param: noVid, Att: "_" |-> null, Code: skip ;
              return ( emp ) >,
            < "run" : Method | Param: noVid, Att: "label:1" |-> null,
              "label:0" |-> null, "y" |-> null, "_" |-> null,
              Code: call( "label:0" ; "b" ; "remove" ; emp ) ;
              get( "label:0" ; "y" ) ; free( "label:0" ) ;
              call( "label:1" ; "this" ; "run" ; emp ) ; free( "label:1" ) ;
              return ( emp ) >,
      Ocnt: 0 >
    
    < "Starter" : Class | Inh: noInh, Param: noVid, Att: noSubst,
      Mtds: < "init" : Method | Param: noVid, Att: "_" |-> null, Code: skip ;
              return ( emp ) >,
            < "run" : Method | Param: noVid, Att: "b" |-> null, "p" |-> null,
              "c" |-> null, "_" |-> null,
              Code: new( "b" ; "BoundedBuffer" ; emp ) ;
              new( "p" ; "Producer" ; "b" ) ; new( "c" ; "Consumer" ; "b" ) ;
              return ( emp ) >,
      Ocnt: 0 > .
endm

